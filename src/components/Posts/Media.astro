---
import RedirectedLink from "../RedirectedLink.astro";
import { formatDate, formatSlug } from "../../scripts/util";

import Chafa from "chafa-wasm";
import { promises as fs } from "node:fs";
import path from "node:path";
import { promisify } from "node:util";


/* initialise a single WASM instance */
const chafa = await Chafa();
const imageToHtml = promisify(chafa.imageToHtml);

function viteSrcToAbs(src) {
  return path.resolve(src.replace(/^\/@fs/, "").split("?")[0]);
}

function resolveSrc(src) {
  if (src.startsWith("/@fs")) return viteSrcToAbs(src);
  if (src.startsWith("/_astro/")) {
    return path.resolve(`./dist/${src}`);    // <- adjust glob root if needed
  }
  return path.resolve(src);
}

async function chafaHtml(viteSrc: string) {
  const buf = await fs.readFile(resolveSrc(viteSrc));
  const arrayBuffer = buf.buffer.slice(buf.byteOffset, buf.byteOffset + buf.byteLength);
  const {html} = await imageToHtml(arrayBuffer, {
    // Default values:
  format: chafa.ChafaPixelMode.CHAFA_PIXEL_MODE_SYMBOLS.value,
  width: 60,
  fontRatio: 0.5, // TODO
  colors: chafa.ChafaCanvasMode.CHAFA_CANVAS_MODE_INDEXED_256.value,
  colorExtractor: chafa.ChafaColorExtractor.CHAFA_COLOR_EXTRACTOR_MEDIAN.value,
  colorSpace: chafa.ChafaColorSpace.CHAFA_COLOR_SPACE_RGB.value,
  symbols: "ascii",
  fill: "none",
  fg: 0x000000,
  bg: 0xffffff,
  fgOnly: true,
  dither: chafa.ChafaDitherMode.CHAFA_DITHER_MODE_NONE.value,
  ditherGrainWidth: 4,
  ditherGrainHeight: 4,
  ditherIntensity: 1.0,
  preprocess: true,
  threshold: 0.5,
  optimize: 5,
  work: 1, // TODO
  });
  return html;
}

/* -------- pre-compute ANSI blocks for each post -------- */
// apparently needs to be done cos we cant use await below
const { posts } = Astro.props;

for (const p of posts) {
  p._ascii = [];
  for (const itm of p.data.media.map((m) => m.image || m)) {
    p._ascii.push(await chafaHtml(itm.src));
  }
}
---

<ol>
  {
    posts.map((post) => {
      const { dd, mmm, yyyy } = formatDate(post.data.published);
      const images = post.data.media.map((item) => item.image || item);
      for (const img of images) {
        const html = chafaHtml(img.src);
      }

      return (
        <li>
          <span>
            
            <RedirectedLink
              class = "text"
              href={`/${post.id}`}
              title={post.data.redirect}
              destination={post.data.redirect}
            >


<quote style="font-size: small; color: grey;">I made music about an unused recording booth standing in the lab where I used to work. Sometimes I would lie down there to decompress and think about stuff. It feels like a long time ago.

[Bandcamp]

Instruments and vocals by Marnix Van Soom
Mixed by Marnix Van Soom
Mastered by Jussi De Nys

Much thanks to Hannes Blommaert, Thal√Øa Viaene, Quinten De Cuyper, Simen Wouters, Miki Lamiroy, Simon Beekaert & Frankie Fame for having been a part of this <3 [...]</quote>
<em style="background-color: antiquewhite">EP, 8:56, digital release</em>


                <span>{formatSlug(post.id)}</span>
              
            </RedirectedLink>

            
          </span>

          <div class="date">

            {/* inject chafa-rendered blocks */}
        {post._ascii.map((html, i) => (
          <pre class="ascii"} set:html={html} />
        ))}
            
          </div>
        </li>
      );
    })
  }
</ol>

<style>
  .ascii {
    font-family: monospace;
    white-space: pre;
  line-height: 1.2;
  font-size: 0.25em;
  /*font-size: clamp(10px, 2vw, 14px); /* Responsive sizing */
  }
  </style>