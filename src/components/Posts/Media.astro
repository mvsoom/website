---
import RedirectedLink from "../RedirectedLink.astro";
import { formatDate, formatSlug } from "../../scripts/util";

import Chafa from "chafa-wasm";
import { promises as fs } from "node:fs";
import path from "node:path";
import { promisify } from "node:util";


/* initialise a single WASM instance */
const chafa = await Chafa();
const imageToHtml = promisify(chafa.imageToHtml);

function viteSrcToAbs(src) {
  return path.resolve(src.replace(/^\/@fs/, "").split("?")[0]);
}

function resolveSrc(src) {
  if (src.startsWith("/@fs")) return viteSrcToAbs(src);
  if (src.startsWith("/_astro/")) {
    return path.resolve(`./dist/${src}`);    // <- adjust glob root if needed
  }
  return path.resolve(src);
}

async function chafaHtml(viteSrc: string) {
  const buf = await fs.readFile(resolveSrc(viteSrc));
  const arrayBuffer = buf.buffer.slice(buf.byteOffset, buf.byteOffset + buf.byteLength);
  const {html} = await imageToHtml(arrayBuffer, {
    // Default values:
  format: chafa.ChafaPixelMode.CHAFA_PIXEL_MODE_SYMBOLS.value,
  width: 10,
  fontRatio: 0.5,
  colors: chafa.ChafaCanvasMode.CHAFA_CANVAS_MODE_INDEXED_256.value,
  colorExtractor: chafa.ChafaColorExtractor.CHAFA_COLOR_EXTRACTOR_AVERAGE.value,
  colorSpace: chafa.ChafaColorSpace.CHAFA_COLOR_SPACE_RGB.value,
  symbols: "all",
  fill: "none",
  fg: 0xffffff,
  bg: 0x000000,
  fgOnly: false,
  dither: chafa.ChafaDitherMode.CHAFA_DITHER_MODE_NONE.value,
  ditherGrainWidth: 4,
  ditherGrainHeight: 4,
  ditherIntensity: 1.0,
  preprocess: true,
  threshold: 0.5,
  optimize: 5,
  work: 5,
  });
  return html;
}

/* -------- pre-compute ANSI blocks for each post -------- */
// apparently needs to be done cos we cant use await below
const { posts } = Astro.props;

for (const p of posts) {
  p._ascii = [];
  for (const itm of p.data.media.map((m) => m.image || m)) {
    p._ascii.push(await chafaHtml(itm.src));
  }
}
---

<ol>
  {
    posts.map((post) => {
      const { dd, mmm, yyyy } = formatDate(post.data.published);
      const images = post.data.media.map((item) => item.image || item);
      for (const img of images) {
        const html = chafaHtml(img.src);
      }

      return (
        <li>
          <span>
            <RedirectedLink
              class = "text"
              href={`/${post.id}`}
              title={post.data.redirect}
              destination={post.data.redirect}
            >

<style>
pre.ascii span.graphomaniac { color: #ff7f50; } /* Warm coral-like tones */
pre.ascii span.melancholic { color: #3ab09e; } /* Soft teal-mint, meditative feel */
pre.ascii span.neoseer { color: #7f8cff; }     /* Futuristic cool blue/purple */
</style>

<quote style="font-size: small">In all likelihood… we will be surrounded by animate objects in the future. A considerable part of how the near future will look and feel is being decided now by big corporations and upcoming scientific-economical paradigms such as mortal computing (Hinton 2022). Whatever one’s economic stance, developments this [...]</quote>


                <span>{formatSlug(post.id)}</span>
              
            </RedirectedLink>
          </span>

          <div class="date">

            {/* inject chafa-rendered blocks */}
        {post._ascii.map((html, i) => (
          <pre class="ascii"} set:html={html} />
        ))}
            
          </div>
        </li>
      );
    })
  }
</ol>

<style>
  .ascii {
    font-family: triplicate_a_code;
    white-space: pre;
  line-height: 1.2;
  /*font-size: clamp(10px, 2vw, 14px); /* Responsive sizing */
  }
  </style>