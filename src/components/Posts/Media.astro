---
import RedirectedLink from "../RedirectedLink.astro";
import { formatDate, formatSlug } from "../../scripts/util";

import Chafa from "chafa-wasm";
import { promises as fs } from "node:fs";
import path from "node:path";
import { promisify } from "node:util";


/* initialise a single WASM instance */
const chafa = await Chafa();
const imageToHtml = promisify(chafa.imageToHtml);

function viteSrcToAbs(src) {
  return path.resolve(src.replace(/^\/@fs/, "").split("?")[0]);
}

function resolveSrc(src) {
  if (src.startsWith("/@fs")) return viteSrcToAbs(src);
  if (src.startsWith("/_astro/")) {
    return path.resolve(`./dist/${src}`);    // <- adjust glob root if needed
  }
  return path.resolve(src);
}

async function chafaHtml(viteSrc: string) {
  const buf = await fs.readFile(resolveSrc(viteSrc));
  const arrayBuffer = buf.buffer.slice(buf.byteOffset, buf.byteOffset + buf.byteLength);
  const {html} = await imageToHtml(arrayBuffer, {
    format: chafa.ChafaPixelMode.CHAFA_PIXEL_MODE_SYMBOLS.value,
    height: 5,
    colors: chafa.ChafaCanvasMode.CHAFA_CANVAS_MODE_TRUECOLOR.value
  });
  return html;
}

/* -------- pre-compute ANSI blocks for each post -------- */
const { posts } = Astro.props;

for (const p of posts) {
  p._ascii = [];
  for (const itm of p.data.media.map((m) => m.image || m)) {
    p._ascii.push(await chafaHtml(itm.src));
  }
}
---

<style>
/* global ASCII styling */
pre.ascii {
  font-family: triplicate_a_code, monospace;
  white-space: pre;
  line-height: 1.2;
  font-size: clamp(9px, 1.8vw, 14px);
  margin: 1rem 0;
  overflow-x: auto;
}

/* per-project colours (slug = css class) */
pre.ascii.graphomaniac { color: #ff7f50; }  /* warm coral */
pre.ascii.melancholic  { color: #3ab09e; }  /* soft teal  */
pre.ascii.neoseer      { color: #7f8cff; }  /* cool lilac */
</style>

<ol>
  {posts.map((post) => {
    const { dd, mmm, yyyy } = formatDate(post.data.published);
    const slug = formatSlug(post.id);

    return (
      <li>
        <RedirectedLink
          href={`/${post.id}`}
          class="text"
          title={post.data.redirect}
          destination={post.data.redirect}
        >
          <span>{slug}</span>
        </RedirectedLink>

        {/* inject chafa-rendered blocks */}
        {post._ascii.map((html, i) => (
          <pre class={`ascii ${slug}`} set:html={html} key={i} />
        ))}
      </li>
    );
  })}
</ol>
