---
import RedirectedLink from "../RedirectedLink.astro";
import { formatDate, formatSlug } from "../../scripts/util";

import Chafa from "chafa-wasm";
import { promises as fs } from "node:fs";
import path from "node:path";
import { promisify } from "node:util";

const chafa = await Chafa();                         // new instance
const imageToAnsi = promisify(chafa.imageToAnsi);    // bind once

async function tryChafa(src: string) {
  const absPath = path
    .resolve(
      src
        .replace(/^\/@fs/, "") // strip vite dev prefix
        .split("?")[0]         // drop query params
    );

  console.log("absPath", absPath);

  const raw = await fs.readFile(absPath);
  
  const arrayBuffer = raw.buffer.slice(raw.byteOffset, raw.byteOffset + raw.byteLength);
  
  try {
    /* call directly – it’s synchronous */
    const { ansi } = await imageToAnsi(arrayBuffer, {
      format: chafa.ChafaPixelMode.CHAFA_PIXEL_MODE_SYMBOLS.value,
      height: 5,
      fontRatio: 0.5,
      colors: chafa.ChafaCanvasMode.CHAFA_CANVAS_MODE_TRUECOLOR.value,
      colorExtractor: chafa.ChafaColorExtractor.CHAFA_COLOR_EXTRACTOR_AVERAGE.value,
      colorSpace: chafa.ChafaColorSpace.CHAFA_COLOR_SPACE_RGB.value,
      symbols: "all",
      fill: "none",
      fg: 0xffffff,
      bg: 0x000000,
      fgOnly: false,
      dither: chafa.ChafaDitherMode.CHAFA_DITHER_MODE_NONE.value,
      ditherGrainWidth: 4,
      ditherGrainHeight: 4,
      ditherIntensity: 1.0,
      preprocess: true,
      threshold: 0.5,
      optimize: 5,
      work: 5,
    });

    console.log(ansi);
  } catch (error) {
    //console.error("Error generating ANSI art for ", absPath, " :", error);
  }
}


const { tag, year, posts } = Astro.props;
---

<ol>
  {
    posts.map((post) => {
      const { dd, mmm, yyyy } = formatDate(post.data.published);
      const images = post.data.media.map((item) => item.image || item);
      for (const img of images) {
        const ansi = tryChafa(img.src);   // wait for each run
        console.log(ansi);
      }

      return (
        <li>
          <span>
            <RedirectedLink
              class = "text"
              href={`/${post.id}`}
              title={post.data.redirect}
              destination={post.data.redirect}
            >

<style>
pre.ascii span.graphomaniac { color: #ff7f50; } /* Warm coral-like tones */
pre.ascii span.melancholic { color: #3ab09e; } /* Soft teal-mint, meditative feel */
pre.ascii span.neoseer { color: #7f8cff; }     /* Futuristic cool blue/purple */
</style>

<quote style="font-size: small">In all likelihood… we will be surrounded by animate objects in the future. A considerable part of how the near future will look and feel is being decided now by big corporations and upcoming scientific-economical paradigms such as mortal computing (Hinton 2022). Whatever one’s economic stance, developments this [...]</quote>


                <span>{formatSlug(post.id)}</span>
              
            </RedirectedLink>
          </span>

          <div class="date">
            
<pre class="ascii">
┌───────────┐
│ ░░░░░░░░░ │
│ ░▒▓▒░░▒▓░ │
│ ░░░░░░░░░ │
└───────────┘
┌───────────┐
│ ░░░░░░░░░ │
│ ░▒▓▒░░▒▓░ │
│ ░░░░░░░░░ │
└───────────┘
┌───────────┐
│ ░░░░░░░░░ │
│ ░▒▓▒░░▒▓░ │
│ ░░░░░░░░░ │
└───────────┘
┌───────────┐
|⠀⠀⣴⣆⠀⠀⠀⠀⠀|
|⠂⣠⣘⡏⠀⠀⠀⠀⠀|
|⡳⣷⡾⢣⠀⠀⠀⠠⣠|
|⠛⠛⠀⢠⢀⡶⠂⢐⣡|
|⣶⣦⢀⣜⢷⣷⢞⡥⠾|
└───────────┘

</pre>
          </div>
        </li>
      );
    })
  }
</ol>

<style>
  .ascii {
    font-family: triplicate_a_code;
    white-space: pre;
  line-height: 1.2;
  /*font-size: clamp(10px, 2vw, 14px); /* Responsive sizing */
  }
  </style>