---
import RedirectedLink from "../RedirectedLink.astro";
import { formatDate, formatSlug } from "../../scripts/util";
import { FONT_RATIO, FONT_SYMBOLS } from "../../scripts/chafa";

import Chafa from "chafa-wasm";
import { promises as fs } from "node:fs";
import path from "node:path";
import { promisify } from "node:util";

const fontFamily  = 'triplicate_a_code_regular';
const fontRatio  = FONT_RATIO[fontFamily];
const fontSymbols = FONT_SYMBOLS[fontFamily];

const chafaHeight = 1; // Number of text lines
const chafaDensity = 4; // Number of Chafa blocks per line

/* initialise a single WASM instance */
const chafa = await Chafa();
const imageToHtml = promisify(chafa.imageToHtml);

function viteSrcToAbs(src) {
  return path.resolve(src.replace(/^\/@fs/, "").split("?")[0]);
}

function resolveSrc(src) {
  if (src.startsWith("/@fs")) return viteSrcToAbs(src);
  if (src.startsWith("/_astro/")) {
    return path.resolve(`./dist/${src}`);    // <- adjust glob root if needed
  }
  return path.resolve(src);
}

async function chafaHtml(viteSrc: string) {
  const buf = await fs.readFile(resolveSrc(viteSrc));
  const arrayBuffer = buf.buffer.slice(buf.byteOffset, buf.byteOffset + buf.byteLength);
  const {html} = await imageToHtml(arrayBuffer, {
  format: chafa.ChafaPixelMode.CHAFA_PIXEL_MODE_SYMBOLS.value,
  height: chafaHeight*chafaDensity,
  fontRatio: fontRatio,
  colors: chafa.ChafaCanvasMode.CHAFA_CANVAS_MODE_FGBG.value,
  //colors: chafa.ChafaCanvasMode.CHAFA_CANVAS_MODE_TRUECOLOR.value,
  colorExtractor: chafa.ChafaColorExtractor.CHAFA_COLOR_EXTRACTOR_MEDIAN.value,
  colorSpace: chafa.ChafaColorSpace.CHAFA_COLOR_SPACE_RGB.value,
  symbols: fontSymbols,
  fill: "none",
  fg: 0x000000,
  bg: 0xffffff,
  fgOnly: true,
  dither: chafa.ChafaDitherMode.CHAFA_DITHER_MODE_NONE.value,
  ditherGrainWidth: 4,
  ditherGrainHeight: 4,
  ditherIntensity: 1.0,
  preprocess: true,
  threshold: 0.5,
  optimize: 5,
  work: 1, // TODO
  });
  return html;
}

/* -------- pre-compute ANSI blocks for each post -------- */
// apparently needs to be done cos we cant use await below
const { tag, year, posts } = Astro.props;

for (const p of posts) {
  p._ascii = [];
  for (const itm of p.data.media.map((m) => m.image || m)) {
    p._ascii.push(await chafaHtml(itm.src));
  }
}
---

<style define:vars={{ fontRatio, fontFamily, chafaHeight: chafaDensity }}>
  .ascii {
    font-family: var(--fontFamily), monospace;
    white-space: pre;
    letter-spacing: 0;
    font-size: calc(1em / var(--chafaHeight));
    line-height: calc(1em / var(--fontRatio));
    margin: 0;
    padding: 0;

    /* ↓ new stuff ↓ */
  display: inline-block;     /* let them sit side-by-side */
  vertical-align: text-bottom;       /* align all “images” by their tops */
  /* optional spacing between them: */
  margin-right: 0.5em;
  }
</style>

<ol>
  {
    posts.map((post) => {
      const { dd, mmm, yyyy } = formatDate(post.data.published);
      const images = post.data.media.map((item) => item.image || item);
      for (const img of images) {
        const html = chafaHtml(img.src);
      }

      return (
        <li>
          <span>
            
            <RedirectedLink
              class = "text"
              href={`/${post.id}`}
              title={post.data.redirect}
              destination={post.data.redirect}
            >







{/* inject chafa-rendered blocks */}
[{post._ascii.map((html, i) => (
          <pre class="ascii"} set:html={html} />
        ))}]




[<em style="background-color: none">EP, 8:56, digital release</em>]




<span>{formatSlug(post.id)}</span>
                
              
            </RedirectedLink>

            
          </span>

          <div class="date">
            <span style="font-size: smaller;">{mmm}</span>
            <br />
            <a href={`/${tag}/${year}`} class="text">
              {yyyy}
            </a>
          </div>
        </li>
      );
    })
  }
</ol>