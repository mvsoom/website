---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import {
  getPosts,
  groupByTagAndYear,
  sortDescending,
  sortPostsDescending,
} from "../../../scripts/posts";
import RedirectedLink from "../../../components/RedirectedLink.astro";
import { formatDate } from "../../../scripts/util";

export async function getStaticPaths() {
  const grouped = groupByTagAndYear(await getPosts());
  const paths = [];

  for (const tag in grouped) {
    const years = Object.keys(grouped[tag]);
    paths.push({
      params: { tag },
      props: { years },
    });

    for (const year of years) {
      const posts = grouped[tag][year];
      paths.push({
        params: { tag, year },
        props: { posts },
      });
    }
  }

  return paths;
}

const { tag, year } = Astro.params;
let { posts, years } = Astro.props;

posts = posts && sortDescending(posts);
years = years && years.sort((a, b) => Number(b) - Number(a));
---

<BaseLayout pageTitle={Astro.url.pathname}>
  <div class="container">
    <div class="title">
      <h1>{tag}</h1>
    </div>

    {
      posts && (
        <div class={`content list ${tag}`}>
          <h1>{year}</h1>
          <ol>
            {posts.map((post) => {
              const { dd, mmm } = formatDate(post.data.published);
              return (
                <li>
                  <RedirectedLink
                    href={`/${post.id}`}
                    title={post.data.title}
                    destination={post.data.redirect}
                  >
                    {post.id}
                  </RedirectedLink>

                  <div class="date">
                    {mmm}&#8239;<sup>{dd}</sup>
                  </div>
                </li>
              );
            })}
          </ol>
        </div>
      )
    }

    {
      years && (
        <div class={`content list ${tag}`}>
        </div>

        <script
          src="https://unpkg.com/infinite-scroll@4/dist/infinite-scroll.pkgd.min.js"
          is:inline></script>
        
        <div id="data" data-tag={tag} data-years={years}></div>

        <script client:load>
          const tag = document.querySelector("#data").dataset.tag;
          const years = document
            .querySelector("#data")
            .dataset.years.split(",");
          
          console.log("tag", tag);
          console.log("years", years);

          function getYearPath() {
            var slug = years[this.loadCount];
            console.log("slug", `/${tag}/${slug}`);
            if (slug) {
              return `/test/${tag}/${slug}`;
            }
          }

          var target = `.content.list.${tag}`;
          var infScroll = new InfiniteScroll(target, {
            path: getYearPath,
            append: target,
            prefill: true,
          });
        </script>
      )
    }
  </div>
</BaseLayout>
