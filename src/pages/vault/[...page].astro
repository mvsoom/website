---
import "../../styles/global.css";
import { getSortedPosts, groupByYear } from "../../scripts/posts";
import { formatDate } from "../../scripts/util";
import type { GetStaticPaths } from "astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import RedirectedLink from "../../components/RedirectedLink.astro";

export const pageSize = 25;

export const getStaticPaths = (async ({ paginate }) => {
  const posts = await getSortedPosts();

  return paginate(posts, { pageSize: pageSize });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

const postsByYear = groupByYear(page.data);

const pageTitle = "vault";
---

<BaseLayout pageTitle={pageTitle}>
  <div class="container">
    <div class="title">
      <h1>vault</h1>
      <p>All the posts</p>
    </div>

    <div
      class="content list"
      data-infinite-scroll='{ "path": "./{{#}}", "append": ".minipage", "checkLastPage": true, "prefill": true }'
    >
      <div class="minipage">
        {
          Object.keys(postsByYear)
            .sort((a, b) => b - a)
            .map((year) => (
              <>
                <h1>{year}</h1>
                <ol>
                  {postsByYear[year].map((post) => {
                    const { dd, mmm } = formatDate(post.data.published);
                    return (
                      <li>
                        <RedirectedLink
                          href={`/${post.id}`}
                          title={post.data.title}
                          destination={post.data.redirect}
                        >
                          {post.id}
                        </RedirectedLink>

                        <div class="date">
                          {mmm}&#8239;<sup>{dd}</sup>
                        </div>
                      </li>
                    );
                  })}
                </ol>
              </>
            ))
        }
      </div>
    </div>
  </div>

  <!-- TODO: enable bundling via local file? Cannot import this in frontmatter; Astro complains and says to put this in script file, which can in principle still be optimized -->
  <script
    src="https://unpkg.com/infinite-scroll@4/dist/infinite-scroll.pkgd.min.js"
    is:inline></script>
</BaseLayout>
