---
import "../../styles/global.css";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getPosts } from "../../scripts/posts";

async function getDescendingYears() {
  const posts = await getPosts();

  const filteredPosts = posts.filter(
    (post) => post.data.research !== undefined
  );

  const years = [
    ...new Set(
      filteredPosts.map((post) => post.data.published!.getFullYear()).flat()
    ),
  ];

  return years.sort((a, b) => b - a);
}

const years = await getDescendingYears();
console.log(years);

const pageTitle = "research";
---

<style>
  .content.list ol li {
    margin-bottom: 2em;
  }

  .content.list ol li .date {
    font-size: smaller;
  }
</style>

<BaseLayout pageTitle={pageTitle}>
  
  <div class="container">
    <div class="title">
      <h1><a href="/research">research</a></h1>
    </div>

    <div
      class="content list"
      data-years={years}
    >
    </div>

    <!-- TODO: enable bundling via local file? Cannot import this in frontmatter; Astro complains and says to put this in script file, which can in principle still be optimized -->
    <script
      src="https://unpkg.com/infinite-scroll@4/dist/infinite-scroll.pkgd.min.js"
      is:inline></script>

    <script client:load>
      // Read the years from the data attribute
      const nextPenSlugs = document.querySelector(".content.list").dataset.years.split(",");

      console.log("in js: years:");
      console.log(nextPenSlugs);

      function getPenPath() {
        var slug = nextPenSlugs[this.loadCount];
        if (slug) {
          return "/research/" + slug;
        }
      }

      //-------------------------------------//
      // init Infinte Scroll

      var infScroll = new InfiniteScroll(".content.list", {
        path: getPenPath,
        append: ".content.list",
        prefill: true,
      });
    </script>
  </div>
</BaseLayout>
